<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <meta name="description" content="Out of the box, Drupal 7 comes with the ability to set the global cache lifetime for all pages on the site, this often is not enough for complex sites.">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- OpenGraph Tags -->
    <meta property="og:title" content="Dynamic content caching based on attributes in Drupal 7" />
    <meta property="og:site_name" content="Pixelite" />
    <meta property="og:url" content="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/" />
    <meta property="og:description" content="Simple code to maximise your varnish hitrate" />
    <meta property="fb:app_id" content="410615979137383" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    
        <meta property="og:image" content="http://www.pixelite.co.nz/img/cache-attributes.jpg" />
    

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@pixelite_">
    
        <meta name="twitter:creator" content="@wiifm">
    
    <meta name="twitter:title" content="Dynamic content caching based on attributes in Drupal 7">
    <meta name="twitter:description" content="Simple code to maximise your varnish hitrate">
    
        <meta name="twitter:image" content="http://www.pixelite.co.nz/img/cache-attributes.jpg">
    


    <title>Dynamic content caching based on attributes in Drupal 7 - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    
<!-- Main Content -->
<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="1257"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/"/>

    <header class="intro-header" style="background-image: url('/img/cache-attributes.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 itemprop="name headline">Dynamic content caching based on attributes in Drupal 7</h1>
                    
                    <h2 class="subheading" itemprop="description">Simple code to maximise your varnish hitrate</h2>
                    

                    <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2015-09-06T00:00:00" itemprop="datePublished">September 6, 2015</time></span>
                    <ul class="social-buttons cf">
                        <li>
                            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Dynamic content caching based on attributes in Drupal 7" data-url="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                        </li>
                        <li>
                            <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                        </li>
                        <li>
                            <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/&amp;t=Dynamic%20content%20caching%20based%20on%20attributes%20in%20Drupal%207" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                        </li>
                        <li>
                            <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/&amp;title=Dynamic%20content%20caching%20based%20on%20attributes%20in%20Drupal%207" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>

    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <p>Out of the box, Drupal 7 comes with the ability to set the global cache lifetime for all pages on the site. I find this works generally quite well with small sites with not a lot of content or complex caching requirements. <a href="https://pantheon.io/docs/articles/drupal/drupal-performance-and-caching-settings/">Pantheon have a nice write</a> up on the performance settings page that comes with Drupal 7 core and what each of the settings mean.</p>

<p><strong>N.B.</strong> In this article I am assuming you are running some form of reverse proxy (e.g. varnish) in front of Drupal (most Drupal managed cloud vendors like Acquia or Pantheon provide varnish as a part of it’s offering as standard).</p>

<h2 id="the-problem-with-drupal-7-core-settings">The problem with Drupal 7 core settings</h2>

<p>What happens when you are running a large site, with a very <a href="https://en.wikipedia.org/wiki/Long_tail">long tail of content</a>? All of a sudden running a global cache <abbr title="Time To Live">TTL</abbr> of 10 minutes can result in a very poor hit rate in varnish. Having a poor hit rate in varnish ultimately means your web servers end up doing more work, which often leads to having to shell out for additional hardware.</p>

<p>Generally, faced with this issue, you have 2 options:</p>

<h2 id="varnish-with-purging">1) Varnish with purging</h2>

<p>In this option, you set a global high cache TTL, so that all content lives in varnish for an excessively long time (say 12 hours), and when certain events occur (say a news article gets published), then purge requests occur telling varnish to drop certain URLs from it’s cache. I don’t want to go into detail to much on this, but I will say there are a number of drawbacks with this approach:</p>

<ul>
  <li>When you publish 1 node, often this node can potentially appear on dozens of pages (e.g. on landing pages as a teaser, or in a view), this means the purge rules get overly complex in a hurry. If you ever re-architect a portion of the site, often this means hundreds of purge rules need to be rewritten and tested, this can be very costly.</li>
  <li>Running a <abbr title="Content Delivery Network">CDN</abbr> (e.g. Akamai, or Cloudflare) can complicate things further, as you need to purge varnish first, then the CDN <em>and never in the reverse order</em>, else the CDN will end up caching the stale content all over again</li>
  <li>Having exposed filters on the page means you will need to use bans in varnish (to utlise regex), this is another topic for another day</li>
  <li>All too often, content editors resort to <em>nuking the varnish cache from orbit</em> and dropping the whole lot when the rules do not function as desired. This is especially bad as it means all the content in there needs to be entirely rebuilt again. This can (and often does) take down busy sites when it occurs in production.</li>
</ul>

<h2 id="varnish-with-intelligent-cache-ttls">2) Varnish with intelligent cache TTLs</h2>

<p>Another option to which I want to discuss in this blog post is around using the attributes of the node in order to determine at runtime how long this piece of content should be cached in varnish.</p>

<p>Attributes you can use to help you work out the most effective cache TTL:</p>

<ul>
  <li>content type</li>
  <li>content created age (now - created)</li>
  <li>recency of most recent revision</li>
  <li>when the last comment was made</li>
  <li>current time of day</li>
  <li>any other attribute of the node</li>
</ul>

<p>What do I mean by this? Well let’s say you run a large digital media organisation, and publish hundreds of fresh news articles per day, but after a week or so, they generally get no edits done to them at all. Your cache TTL rules could be:</p>

<ul>
  <li>if content type == ‘news_article’ then</li>
  <li>if age &lt; 1 week, then the cache TTL inherits from the global configuration</li>
  <li>else if age &gt; 1 week, then increase cache TTL to 1 week</li>
</ul>

<p>This way, your new content is able to get upgrades quite promptly, and your long tail of older news articles have a massively inflated cache TTL, meaning your varnish server should really be able to help out here. It is important to note, that these rules apply at a node by node level, and can be made to suit your business requirements.</p>

<h3 id="modules-out-there-already">Modules out there already</h3>

<p>I had a look around on Drupal.org to see what others had done in this area in the past, I was genuinely surprised at the lack of modules in this area, here is a short summary:</p>

<ul>
  <li><a href="https://www.drupal.org/project/cacheexclude">cacheexclude</a> - used to exclude certain URLs from cache, kind of the opposite of what we want here.</li>
  <li><a href="https://www.drupal.org/project/max_age">max_age</a> - an (abandoned?) Drupal 6 module that aimed to provide different cache TTLs per content type in addition to the site wide default. This is close to what we want, there even is a <a href="https://www.drupal.org/node/1322158">patch to help port the module to Drupal 7</a>.</li>
</ul>

<h3 id="example-code">Example code</h3>

<p>Rather than using any existing contrib modules, the code required to do what we want is very simple. Here is some simple custom code that can be used as a starting point for your code:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Implements hook_page_build().</span>
<span class="sd"> *</span>
<span class="sd"> * Responsible for setting the cache TTL based on the content attributes.</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">MYMODULE_page_build</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$page</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nx">menu_get_object</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">drupal_page_is_cacheable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$node</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$age_since_last_change</span> <span class="o">=</span> <span class="nx">REQUEST_TIME</span> <span class="o">-</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">changed</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;news_article&#39;</span> <span class="o">:</span>
        <span class="c1">// If the news article has not been edited in a week, then set the cache</span>
        <span class="c1">// TTL to a week.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$age_since_last_change</span> <span class="o">&gt;</span> <span class="mi">604800</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$max_age</span> <span class="o">=</span> <span class="mi">604800</span><span class="p">;</span>
          <span class="nx">drupal_add_http_header</span><span class="p">(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span> <span class="s1">&#39;public,max-age=&#39;</span> <span class="o">.</span> <span class="nv">$max_age</span><span class="p">);</span>
          <span class="nx">drupal_add_http_header</span><span class="p">(</span><span class="s1">&#39;Expires&#39;</span><span class="p">,</span> <span class="nb">gmdate</span><span class="p">(</span><span class="nx">DATE_RFC1123</span><span class="p">,</span> <span class="nx">REQUEST_TIME</span> <span class="o">+</span> <span class="nv">$max_age</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>The above example is simple, but hopefully gives you a taste of what can be achieved with very little code.</p>

<h3 id="how-to-test-your-code">How to test your code</h3>

<p>I have a few cURL aliases in my <code>.bashrc</code> that will come in handy if you do a lot of this type of thing:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># cURL</span>
<span class="k">function</span> curlh<span class="o">()</span> <span class="o">{</span> curl -sLIXGET <span class="s2">&quot;$@&quot;</span><span class="p">;</span> <span class="o">}</span>
<span class="k">function</span> curlc<span class="o">()</span> <span class="o">{</span> curl -sLIXGET <span class="s2">&quot;$@&quot;</span> <span class="p">|</span> grep -E -i <span class="s2">&quot;^(Cache-Control|Age|Expires|Set-Cookie|X-Cache|X-Varnish|X-Hits|Vary)&quot;</span><span class="p">;</span> <span class="o">}</span></code></pre></div>

<p>So if you are after all response headers you can:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curlh www.example.com
HTTP/1.1 <span class="m">200</span> OK
Accept-Ranges: bytes
Cache-Control: max-age<span class="o">=</span>604800
Content-Type: text/html
Date: Sun, <span class="m">06</span> Sep <span class="m">2015</span> 22:52:40 GMT
Etag: <span class="s2">&quot;359670651&quot;</span>
Expires: Sun, <span class="m">13</span> Sep <span class="m">2015</span> 22:52:40 GMT
Last-Modified: Fri, <span class="m">09</span> Aug <span class="m">2013</span> 23:54:35 GMT
Server: ECS <span class="o">(</span>cpm/F9D5<span class="o">)</span>
X-Cache: HIT
x-ec-custom-error: 1
Content-Length: 1270
Connection: Keep-Alive
Age: 2265</code></pre></div>

<p>If you just want the relevant caching response headers:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curlc www.example.com
Cache-Control: max-age<span class="o">=</span>604800
Expires: Sun, <span class="m">13</span> Sep <span class="m">2015</span> 22:52:40 GMT
X-Cache: HIT
Age: 2249</code></pre></div>

<h3 id="what-this-technique-relies-on">What this technique relies on</h3>

<ol>
  <li><strong>Expectation setting</strong> - you will need to ensure all content authors and stakeholders are aware what this means. If a really old news article is edited, there potentially will be lag before the changes are live.</li>
  <li><strong>Enough RAM in varnish</strong> to house all your objects. If you are RAM constrained, and are seeing a lot of evictions at present, then this technique will not have the impact you will want it to. You might be better to upsize varnish first, then look at this technique.</li>
</ol>

<h2 id="comments">Comments</h2>

<p>I am keen to hear what other large websites do in the area, especially around multiple layers of external cache invalidation and/or if custom cache TTL headers are used. Also if you know of any other contrib modules that can help here, let me know.</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    var disqus_url = 'http://www.pixelite.co.nz/article/dynamic-content-caching-based-on-attributes-in-drupal-7/';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/starter-regression-test-suite-powered-by-casperjs/" data-toggle="tooltip" data-placement="top" title="Starter regression test suite powered by CasperJS">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2015 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
