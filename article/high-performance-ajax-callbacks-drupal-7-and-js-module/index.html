<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="As your site grows with the number of modules, the amount of memory and SQL queries required to perform a full bootstrap grows. Even though your AJAX callback might only need to perform a single SQL SELECT query, sometimes Drupal spends a lot of time loading and executing code that will never be used.">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>High performance AJAX callbacks with Drupal 7 and the JS module - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" width="180" height="60" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    

<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="682"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module"/>

    <!-- Post Header -->
    <header class="intro-header" style="background-image: url('/')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1 itemprop="name headline">High performance AJAX callbacks with Drupal 7 and the JS module</h1>
                        

                        <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2013-11-28T00:00:00" itemprop="datePublished">November 28, 2013</time></span>
                        <ul class="social-buttons cf">
                            <li>
                                <a href="http://twitter.com/share" class="socialite twitter-share" data-text="High performance AJAX callbacks with Drupal 7 and the JS module" data-url="http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                            </li>
                            <li>
                                <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                            </li>
                            <li>
                                <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module&amp;t=High%20performance%20AJAX%20callbacks%20with%20Drupal%207%20and%20the%20JS%20module" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                            </li>
                            <li>
                                <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module&amp;title=High%20performance%20AJAX%20callbacks%20with%20Drupal%207%20and%20the%20JS%20module" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <p>As your site grows with the number of modules, the amount of memory and SQL queries required to perform a full bootstrap grows. Even though your AJAX callback might only need to perform a single SQL SELECT query, sometimes Drupal spends a lot of time loading and executing code that will never be used.</p>

<h2 id="introducing-the-js-module">Introducing the JS module</h2>

<p>The <a href="https://drupal.org/project/js">JS module</a> aims to solve this problem by providing an alternative way to bootstrap to <em>only</em> the required level needed to perform the task at hand. This has a major advantage of including only the necessary files needed to serve the request.</p>

<p>From the module’s description:</p>

<blockquote>
JavaScript callback handler is an interim solution for high-performance server requests including (but not limited to) AHAH, AJAX, JSON, XML, etc.

This project targets module developers and provides a "bare bone" callback handler which is intended to be addressed by modules wanting to improve response times for specialized tasks.
</blockquote>

<h2 id="drupal-and-bootstrap-levels">Drupal and bootstrap levels</h2>

<p>By default a vanilla hook_menu() in Drupal will bootstrap to DRUPAL_BOOTSTRAP_FULL, which means it will load in all .module files, and execute hook_boot() and hook_init() for all enabled modules. With the JS module however you can select the bootstrap level you wish to go to (the less levels you load, the faster your code can effectively be), the only trade-off is in the functionality you might not have available.</p>

<p>Here is a list of the <a href="https://api.drupal.org/api/drupal/includes!bootstrap.inc/function/drupal_bootstrap/7">bootstrap levels defined in Drupal core</a> (highest are the most lightweight, with each layer adding code and complexity):</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">static $phases = array(</span>
<span class="x">  DRUPAL_BOOTSTRAP_CONFIGURATION,</span>
<span class="x">  DRUPAL_BOOTSTRAP_PAGE_CACHE,</span>
<span class="x">  DRUPAL_BOOTSTRAP_DATABASE,</span>
<span class="x">  DRUPAL_BOOTSTRAP_VARIABLES,</span>
<span class="x">  DRUPAL_BOOTSTRAP_SESSION,</span>
<span class="x">  DRUPAL_BOOTSTRAP_PAGE_HEADER,</span>
<span class="x">  DRUPAL_BOOTSTRAP_LANGUAGE,</span>
<span class="x">  DRUPAL_BOOTSTRAP_FULL,</span>
<span class="x">);</span></code></pre></div>

<p>For example if you wished to use the function variable_get() in your AJAX callback, you would need to ensure you had bootstrapped to at least the DRUPAL_BOOTSTRAP_VARIABLES level, and if you required access to the current $user object you would need DRUPAL_BOOTSTRAP_SESSION etc.</p>

<h2 id="real-world-site-performance-of-the-js-module">Real world site performance of the JS module</h2>

<p>In order to demonstrate the difference in performance, I decided to create a really simple module that highlights the difference between a traditional full Drupal bootstrap and the lightweight approach of the JS module. This simple module can be <a href="https://drupal.org/sandbox/wiifm/2145789">cloned from my sandbox on Drupal.org</a>.</p>

<p>On a large site with more than 185 modules enabled (including memcache + entitycache), I ran a series of tests to see what impact that had</p>

<h3 id="full-bootstrap-default-drupal-hookmenu">Full bootstrap (default Drupal hook_menu())</h3>

<p><strong>After a drush cc all</strong> (206 database queries):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">seanh@wiifm /var/www/example git:master » <span class="nb">time </span>curl http://example.co.nz/js_example/results/35513
    <span class="o">{</span><span class="s2">&quot;title&quot;</span>:<span class="s2">&quot;Example node title&quot;</span>,<span class="s2">&quot;success&quot;</span>:true<span class="o">}</span>
    real	0m5.085s</code></pre></div>

<p><strong>Primed cache</strong> (17 database queries):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">seanh@wiifm /var/www/example git:master » <span class="nb">time </span>curl http://example.co.nz/js_example/results/35513
    <span class="o">{</span><span class="s2">&quot;title&quot;</span>:<span class="s2">&quot;Example node title&quot;</span>,<span class="s2">&quot;success&quot;</span>:true<span class="o">}</span>
    real	0m0.514s</code></pre></div>

<h3 id="lightweight-bootstrap-with-js-module-bootstrapping-to-drupalbootstrapdatabase">Lightweight bootstrap (with JS module bootstrapping to DRUPAL_BOOTSTRAP_DATABASE)</h3>

<p><strong>After a drush cc all</strong> (9 database queries):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">seanh@wiifm /var/www/example git:master » <span class="nb">time </span>curl http://example.co.nz/js/js_example/results/35513
    <span class="o">{</span><span class="s2">&quot;title&quot;</span>:<span class="s2">&quot;Example node title&quot;</span>,<span class="s2">&quot;success&quot;</span>:true<span class="o">}</span>
    real	0m0.300s</code></pre></div>

<p><strong>Primed cache</strong> (6 database queries):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">seanh@wiifm /var/www/example git:master » <span class="nb">time </span>curl http://example.co.nz/js/js_example/results/35513
    <span class="o">{</span><span class="s2">&quot;title&quot;</span>:<span class="s2">&quot;Example node title&quot;</span>,<span class="s2">&quot;success&quot;</span>:true<span class="o">}</span>
    real	0m0.078s</code></pre></div>

<p>The saving in terms of speed (more than 6 times faster with a primed cache) an less system resources (around one third of the database queries with a primed cache) are remarkable.</p>

<h2 id="limitations">Limitations</h2>

<p>Access control can be trickier when on the lightweight bootstrap, so be careful and if anything be overly paranoid about any data you receive. You may also want to read up about <a href="http://www.pixelite.co.nz/article/sql-injection-and-drupal-7-top-1-10-owasp-security-risks">SQL injection and Drupal 7 - top 1 of 10 OWASP security risks</a></p>

<p>Performing theming can get tricky as well with a lightweight bootstrap, so if you need to harness the power of view modes, templating and node rendering, you might be better off to use a full bootstrap.</p>

<h2 id="comments">Comments</h2>

<p>Let me know if you have used the JS module in your Drupal site (and a link if it is public), and I would also be interested to see what benchmarks you get by running my sandbox module on your latest Drupal site.</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    var disqus_url = 'http://www.pixelite.co.nz/article/high-performance-ajax-callbacks-drupal-7-and-js-module';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/error-aggregation-and-alerting-drupal-7-and-raygunio" data-toggle="tooltip" data-placement="top" title="Error aggregation and alerting with Drupal 7 and Raygun.io">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/sql-injection-and-drupal-7-top-1-10-owasp-security-risks" data-toggle="tooltip" data-placement="top" title="SQL injection and Drupal 7 - top 1 of 10 OWASP security risks">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2015 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
