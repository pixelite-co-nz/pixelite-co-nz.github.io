---
layout: post
title: Using EntityCache to speed up your Drupal site
subtitle: "Make your Drupal sites faster"
header-img: "img/post-bg-02.jpg"
permalink: /article/using-entitycache-speed-your-drupal-site
author: "Sean Hamlin"
categories:
- tutorial
tags:
- drupalplanet
- caching
- performance
- database
- drupal
---

<p>As you are aware Drupal likes to query the database, a lot. On complex pages it is not uncommon to have over 1,000 database queries occur. With the introduction of fields into Drupal 7, now in order to fully load a node, Drupal now also needs to join across many tables. Quickly you can see there being a scalability issue here.</p><p>Luckily with Drupal 7, there is a pluggable caching and entity loading system. This means you can replace Drupal's default entity loading mechanism with another. Out of the box, <a href="http://drupal.org/project/entitycache">entitycache</a> replaces the caching mechanism for core entities:</p><ul><li>comment</li><li>file</li><li>node</li><li>taxonomy_term</li><li>taxonomy_vocabulary</li><li>user</li></ul><h2>Under the hood</h2><p>What entitycache is doing behind the scenes is writting the completely loaded entities to a caching table (cache_entity_[entity-type]). The selects from these tables is inherantly faster than stock Drupal's joining across many tables.</p><h2>Real life example page speed</h2><p>On a complex site I am building now, one of the nodes, has another 12 nodes listed on there (this is currently done with EntityFieldQuery, but it could just as easily been views). Here are some metrics:</p><p><strong>No entitycache, page loadedâ€‹ first thing after a clear cache</strong></p>
<pre class="true; codetag prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><span class="typ">Executed</span><span class="pln"> </span><span class="lit">1590</span><span class="pln"> queries </span><span class="kwd">in</span><span class="pln"> </span><span class="lit">1897.61</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Queries</span><span class="pln"> exceeding </span><span class="lit">5</span><span class="pln"> ms are highlighted</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Page</span><span class="pln"> execution time was </span><span class="lit">6728.64</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Memory</span><span class="pln"> used at</span><span class="pun">:</span><span class="pln"> devel_boot</span><span class="pun">()=</span><span class="lit">8.95</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> devel_shutdown</span><span class="pun">()=</span><span class="lit">144.97</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> PHP peak</span><span class="pun">=</span><span class="lit">146.5</span><span class="pln"> MB</span><span class="pun">.</span></li></ol></pre>
<p><strong>No entitycache, cache primed</strong></p>
<pre class="true; codetag prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><span class="typ">Executed</span><span class="pln"> </span><span class="lit">508</span><span class="pln"> queries </span><span class="kwd">in</span><span class="pln"> </span><span class="lit">628.06</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Queries</span><span class="pln"> exceeding </span><span class="lit">5</span><span class="pln"> ms are highlighted</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Page</span><span class="pln"> execution time was </span><span class="lit">1799.17</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Memory</span><span class="pln"> used at</span><span class="pun">:</span><span class="pln"> devel_boot</span><span class="pun">()=</span><span class="lit">9.31</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> devel_shutdown</span><span class="pun">()=</span><span class="lit">89.94</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> PHP peak</span><span class="pun">=</span><span class="lit">90.75</span><span class="pln"> MB</span><span class="pun">.</span></li></ol></pre>
<p>Now we add entitycache.</p><p><strong>With entitycache, page loaded first thing after a clear cache</strong></p>
<pre class="true; codetag prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><span class="typ">Executed</span><span class="pln"> </span><span class="lit">1624</span><span class="pln"> queries </span><span class="kwd">in</span><span class="pln"> </span><span class="lit">1964.65</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Queries</span><span class="pln"> exceeding </span><span class="lit">5</span><span class="pln"> ms are highlighted</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Page</span><span class="pln"> execution time was </span><span class="lit">6768.48</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Memory</span><span class="pln"> used at</span><span class="pun">:</span><span class="pln"> devel_boot</span><span class="pun">()=</span><span class="lit">8.95</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> devel_shutdown</span><span class="pun">()=</span><span class="lit">145.17</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> PHP peak</span><span class="pun">=</span><span class="lit">146.75</span><span class="pln"> MB</span><span class="pun">.</span></li></ol></pre>
<p><strong>With entitycache, cache primed</strong></p>
<pre class="true; codetag prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><span class="typ">Executed</span><span class="pln"> </span><span class="lit">396</span><span class="pln"> queries </span><span class="kwd">in</span><span class="pln"> </span><span class="lit">564.3</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Queries</span><span class="pln"> exceeding </span><span class="lit">5</span><span class="pln"> ms are highlighted</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Page</span><span class="pln"> execution time was </span><span class="lit">1680.65</span><span class="pln"> ms</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Memory</span><span class="pln"> used at</span><span class="pun">:</span><span class="pln"> devel_boot</span><span class="pun">()=</span><span class="lit">7.96</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> devel_shutdown</span><span class="pun">()=</span><span class="lit">89.57</span><span class="pln"> MB</span><span class="pun">,</span><span class="pln"> PHP peak</span><span class="pun">=</span><span class="lit">90.5</span><span class="pln"> MB</span><span class="pun">.</span></li></ol></pre>
<p>As you can see entitycache adds an initial overhead in order to populate the cache tables, but once this is done, all subsequent entity loads are much faster, and there is less database traffic overall (22% less SQL queries).</p><h2>Real life entity loading speed</h2><p>To load 12 nodes using entitycache (this query was taken from the above page generation):</p>
<pre class="true; codetag prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><span class="pln">SELECT cid</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> created</span><span class="pun">,</span><span class="pln"> expire</span><span class="pun">,</span><span class="pln"> serialized FROM cache_entity_node WHERE cid IN </span><span class="pun">(</span><span class="str">'4370'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'122'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2828'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'120'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3648'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3045'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'4356'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3642'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3379'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3067'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'107'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'4376'</span><span class="pun">)</span></li></ol></pre>
<p>Takes 18.34ms.</p><h2>How to install entitycache</h2><p>Simple with drush, I run the development build as it contains a number of new features and fixes.</p>
<pre class="true; codetag prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><span class="pln">drush dl entitycache</span><span class="pun">-</span><span class="lit">7.x</span><span class="pun">-</span><span class="lit">1.x</span><span class="pun">-</span><span class="pln">dev</span></li><li class="L1"><span class="pln">drush en entitycache </span><span class="pun">-</span><span class="pln">y</span></li></ol></pre>
<p>If you have any success stories, let me know in the comments.</p>