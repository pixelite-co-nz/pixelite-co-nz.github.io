<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="This came up when I we were going through our usual regression suite for the production site, this regression suite is now &gt; 1,000 tests, and visits a lot of pages on the site. I noticed that Google Analytics was recording hits for each CasperJS page load. This makes perfect sense, as essentially CasperJS is an entire headless webkit browser that executes all the JavaScript on the page.">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>How to exclude CasperJS from your Google Analytics statistics - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    

<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="598"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics"/>

    <!-- Post Header -->
    <header class="intro-header" style="background-image: url('/')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1 itemprop="name headline">How to exclude CasperJS from your Google Analytics statistics</h1>
                        

                        <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2013-04-09T00:00:00" itemprop="datePublished">April 9, 2013</time></span>
                        <ul class="social-buttons cf">
                            <li>
                                <a href="http://twitter.com/share" class="socialite twitter-share" data-text="How to exclude CasperJS from your Google Analytics statistics" data-url="http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                            </li>
                            <li>
                                <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                            </li>
                            <li>
                                <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics&amp;t=How%20to%20exclude%20CasperJS%20from%20your%20Google%20Analytics%20statistics" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                            </li>
                            <li>
                                <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics&amp;title=How%20to%20exclude%20CasperJS%20from%20your%20Google%20Analytics%20statistics" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <p>This came up when I we were going through our usual regression suite for the production site, this regression suite is now &gt; 1,000 tests, and visits a lot of pages on the site. I noticed that Google Analytics was recording hits for each CasperJS page load. This makes perfect sense, as essentially CasperJS is an entire headless webkit browser that executes <em>all</em> the JavaScript on the page.</p>

<h2 id="remove">How to cleanly remove the statistics</h2>

<p>There are a number of ways you can remove page views from Google Analytics, for example:</p>

<ol>
  <li>Using Google Analytics filters on Google’s website</li>
  <li>Using JavaScript filters on your own website</li>
</ol>

<p>I opted for option #2 - to alter the JavaScript on the website, as this in my mind produced the cleanest result. In this method, no tracking statistics are even sent to Google, and there is no messy UI to deal with. It also saves your statistics admins from having to set up messy filters in Google Analytics, as these if misconfigured, can really mess up your analytics.</p>

<h2 id="code">How to set up the tracking code</h2>

<p>Old tracking code (default tracking code):</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">_gaq</span> <span class="o">=</span> <span class="nx">_gaq</span> <span class="o">||</span> <span class="p">[];</span>
<span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;_setAccount&quot;</span><span class="p">,</span> <span class="s2">&quot;UA-1234567-1&quot;</span><span class="p">]);</span>
<span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;_trackPageview&quot;</span><span class="p">]);</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">ga</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">);</span><span class="nx">ga</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span><span class="nx">ga</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span><span class="nx">ga</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;https:&quot;</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">?</span> <span class="s2">&quot;https://ssl&quot;</span> <span class="o">:</span> <span class="s2">&quot;http://www&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.google-analytics.com/ga.js&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span><span class="nx">s</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">ga</span><span class="p">,</span> <span class="nx">s</span><span class="p">);})();</span></code></pre></div>

<p>Modified tracking code:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/.*(Pingdom|CasperJS).*/gi</span><span class="p">))</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_gaq</span> <span class="o">=</span> <span class="nx">_gaq</span> <span class="o">||</span> <span class="p">[];</span>
  <span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;_setAccount&quot;</span><span class="p">,</span> <span class="s2">&quot;UA-1234567-1&quot;</span><span class="p">]);</span>
  <span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;_trackPageview&quot;</span><span class="p">]);</span>
  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">ga</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">);</span><span class="nx">ga</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span><span class="nx">ga</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span><span class="nx">ga</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;https:&quot;</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">?</span> <span class="s2">&quot;https://ssl&quot;</span> <span class="o">:</span> <span class="s2">&quot;http://www&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.google-analytics.com/ga.js&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span><span class="nx">s</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">ga</span><span class="p">,</span> <span class="nx">s</span><span class="p">);})();</span>
<span class="p">}</span></code></pre></div>

<p>In CasperJS, ensure the correct user agent is set:</p>

<p>I opted to use a Chrome user agent, with an extension on the end to denote CasperJS (and the version).</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">casper</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;casper&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">pageSettings</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">userAgent</span><span class="o">:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.17 (KHTML, like Gecko) Chrome/24.0.1312.60 Safari/537.17 CasperJS/1.0.2&#39;</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h2 id="drupal">How to alter the JavaScript in Drupal</h2>

<p>If you use Drupal, then you can just use the following code in your own custom module:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/**</span>
<span class="cm"> * Implements hook_js_alter().</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">EXAMPLEMODULE_js_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">$javascript</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Alter Google Analytics code to suppress the tracking of CasperJS in the</span>
  <span class="c1">// stats. The checking of the user agent needs to be done at the JS level in</span>
  <span class="c1">// order to have 100% cacheable pages.</span>
  <span class="nx">$scope</span> <span class="o">=</span> <span class="nx">variable_get</span><span class="p">(</span><span class="s1">&#39;googleanalytics_js_scope&#39;</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">);</span>
  <span class="nx">foreach</span> <span class="p">(</span><span class="nx">$javascript</span> <span class="nx">as</span> <span class="nx">$index</span> <span class="o">=&gt;</span> <span class="nx">$js</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$js</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inline&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">$js</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">$scope</span> <span class="o">&amp;&amp;</span> <span class="nx">strpos</span><span class="p">(</span><span class="nx">$js</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="s1">&#39;_gaq.push([&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Add additional JavaScript at the beginning and at the end.</span>
      <span class="nx">$start</span> <span class="o">=</span> <span class="s1">&#39;if (!navigator.userAgent.match(/.*(Pingdom|CasperJS).*/gi)) {&#39;</span><span class="p">;</span>
      <span class="nx">$end</span> <span class="o">=</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
      <span class="nx">$javascript</span><span class="p">[</span><span class="nx">$index</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$start</span> <span class="p">.</span> <span class="nx">$javascript</span><span class="p">[</span><span class="nx">$index</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="p">.</span> <span class="nx">$end</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p><strong>Update 1<sup>st</sup> May 2013</strong></p>

<p>Have updated the JS alter hook to be more robust, as the original code was causing JS errors on Drupal search pages. If you have used the old code, please update the the new code (found above).</p>

<h2 id="more">Wait can you exclude other services from Google Analytics?</h2>

<p>If you look at the above regex on the user agent matching, you can see I have added Pingdom into there as well. This is merely an example to show you the flexibility of this solution. You can adjust the regex to match the user agents you want to block.</p>

<p>If you remove CasperJS from Google Analytics in another fashion (or don’t bother and have a reason), or have some improvements, let me know in the comments.</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    var disqus_url = 'http://www.pixelite.co.nz/article/how-exclude-casperjs-your-google-analytics-statistics';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/using-entitycache-speed-your-drupal-site" data-toggle="tooltip" data-placement="top" title="Using EntityCache to speed up your Drupal site">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/how-computers-see-simple-introduction-computer-vision" data-toggle="tooltip" data-placement="top" title="How computers see. A simple introduction to computer vision">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2015 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
