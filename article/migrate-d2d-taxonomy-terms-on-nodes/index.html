<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <meta name="description" content="Migrate D2D doesn't handle taxonomies on nodes out of the box.">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- OpenGraph Tags -->
    <meta property="og:title" content="Drupal Migrate D2D :: Taxonomy terms on nodes" />
    <meta property="og:site_name" content="Pixelite" />
    <meta property="og:url" content="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/" />
    <meta property="og:description" content="A 'gotcha'" />
    <meta property="fb:app_id" content="410615979137383" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    
        <meta property="og:image" content="http://www.pixelite.co.nz/img/migrate-d2d/migrate-d2d-header.png" />
    

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@pixelite_">
    
        <meta name="twitter:creator" content="@unifex">
    
    <meta name="twitter:title" content="Drupal Migrate D2D :: Taxonomy terms on nodes">
    <meta name="twitter:description" content="A 'gotcha'">
    
        <meta name="twitter:image" content="http://www.pixelite.co.nz/img/migrate-d2d/migrate-d2d-header.png">
    


    <title>Drupal Migrate D2D :: Taxonomy terms on nodes - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    

<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="621"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/"/>

    <!-- Post Header -->
    <header class="intro-header" style="background-image: url('/img/migrate-d2d/migrate-d2d-header.png')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1 itemprop="name headline">Drupal Migrate D2D :: Taxonomy terms on nodes</h1>
                        
                        <h2 class="subheading" itemprop="description">A 'gotcha'</h2>
                        

                        <span class="meta">Posted by <a href="/authors/gold/" title="View Gold's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Gold</span></span></a> on <time datetime="2015-05-14T00:00:00" itemprop="datePublished">May 14, 2015</time></span>
                        <ul class="social-buttons cf">
                            <li>
                                <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Drupal Migrate D2D :: Taxonomy terms on nodes" data-url="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                            </li>
                            <li>
                                <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                            </li>
                            <li>
                                <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/&amp;t=Drupal%20Migrate%20D2D%20::%20Taxonomy%20terms%20on%20nodes" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                            </li>
                            <li>
                                <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/&amp;title=Drupal%20Migrate%20D2D%20::%20Taxonomy%20terms%20on%20nodes" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <p>A migration project I am currently working on hit a small hurdle with taxonomy terms on a content type. This took too long to resolve. Hopefully posting this here will save others the time and hassle I went though.</p>

<h2 id="migrate-d2d">Migrate D2D</h2>
<p>I am going to assume that if you are reading this you are already using the <a href="https://www.drupal.org/project/migrate_d2d">migrate_d2d</a> module so I won’t go into the big explanation about what it is, why you should use it and just how greatful we all should be to <a href="https://www.drupal.org/u/mikeryan">Mike Ryan</a>.</p>

<h2 id="node-migration-and-taxonomies">Node migration and taxonomies</h2>
<p>After following the docs I found that my taxonomy field was not being populated. A little digging led me to the conclusion that this was not something d2d handled out of the box and it was something I would have to deal with myself. There are a number of moving parts involved with this and due to all of these I can understand <em>why</em> it is not something migrate d2d could do.</p>

<h3 id="public-function-prepareentity-row">public function prepare($entity, $row)</h3>
<p>The magic happens here.  The <code>prepare()</code> function is the final thing to be called before the node object is saved. This is where we get to do any final tweaks or tidyups. You can find full detail on this in the <a href="https://www.drupal.org/node/1132582">Commonly implemented Migration methods</a> page in the <a href="https://www.drupal.org/migrate">Migrate handbook</a>.</p>

<p>In the <code>prepare()</code> function the <code>$entity</code> is the new object that we are about to save and the <code>$row</code> is our source object. At this point the taxonomy has been added to the <code>$row</code>.</p>

<p>Within the <code>$row</code> object the taxonomy has been added with its vid as the root level attribute. If you don’t know to watch for that it can catch you. Added to that it is the vid of the destination vocabulary that is used which caught me off guard. The situation I had did not have me migrating the vobacularies, just the terms within them and the vid for the Categories vocab was not the same on my development environment as it was on my staging environment. This caught me out initially as I don’t have direct access to the staging database to examine the content of tables.</p>

<figure>
  <img src="http://www.pixelite.co.nz/img/migrate-d2d/row_object_krumo.png" alt="Krumo output of $row." class="img-responsive img-thumbnail" />
  <figcaption><small>source $row-&gt;{destination vid} = array({source tid}, {source tid}, {source tid})</small></figcaption>
</figure>

<p>Once it was realised that the vid was from the destination vocabulary things got easier.  This is how the code looked in the end for me;</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">prepare</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The node&#39;s terms are in an array under their destination vocab ID and</span>
    <span class="c1">// this is different from environment to environment. However, we&#39;ve only</span>
    <span class="c1">// got one taxonomy...</span>
    <span class="nv">$keys</span> <span class="o">=</span> <span class="nb">array_keys</span><span class="p">((</span><span class="k">array</span><span class="p">)</span> <span class="nv">$row</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keys</span> <span class="k">as</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$cat_vid</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$cat_vid</span><span class="p">}))</span> <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$cat_vid</span><span class="p">}</span> <span class="k">as</span> <span class="nv">$tid</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We want the tid of the term we have migrated. This lets us look it up</span>
        <span class="c1">// our migrate_map table.</span>
        <span class="nv">$new_tid</span> <span class="o">=</span> <span class="nx">db_select</span><span class="p">(</span><span class="s1">&#39;migrate_map_tncategoryterms&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">fields</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;destid1&#39;</span><span class="p">))</span>
          <span class="o">-&gt;</span><span class="na">condition</span><span class="p">(</span><span class="s1">&#39;sourceid1&#39;</span><span class="p">,</span> <span class="nv">$tid</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">execute</span><span class="p">()</span>
          <span class="o">-&gt;</span><span class="na">fetchField</span><span class="p">();</span>
        <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">field_category</span><span class="p">[</span><span class="nx">LANGUAGE_NONE</span><span class="p">][][</span><span class="s1">&#39;tid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$new_tid</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<h3 id="caveats">Caveats</h3>
<p>This worked for me because I only had <strong>one</strong> taxonomy field to worry about. The moment you get more than one you will want to revisit the assignment of $new_tid to the appropriate field. This shouldn’t be a problem to hand code and if you have migrated the vocabularies too you may be able to use the migrate_map table to make something more dynamic.</p>

<h2 id="comments">Comments</h2>

<p>If you have (or are currently) using migrate I would be interested to hear how you found it. Especially if you are migrating terms, but not the vocabulary.</p>


                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    var disqus_url = 'http://www.pixelite.co.nz/article/migrate-d2d-taxonomy-terms-on-nodes/';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/how-why-you-should-update-php-to-55-with-drupal/" data-toggle="tooltip" data-placement="top" title="How and why you should update PHP to PHP 5.5 with Drupal">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/top-10-drupalcon-la-sessions/" data-toggle="tooltip" data-placement="top" title="Top 10 DrupalCon LA sessions">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2015 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
