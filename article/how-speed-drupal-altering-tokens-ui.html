<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <meta name="description" content="On larger Drupal sites, the Token module quickly becomes unwieldy, and the UI can consume precious resources while    often being never used. Here are some options for mitigation of this.Token_tweaks moduleWritten by    the same guy who wrote token, token_tweaks aims to reduce the    recursiveness of the theme_token_tree() function. This simple fix is enough on most sites to speed up page loads,    and reduce memory consumption.This is a real life example from a current (large) Drupal project I am working    on. With vanilla token module installed, and viewing an admin page with a theme_token_tree() rendered on it (it    happens to be a webform configuration page).&nbsp;I used devel to    produce these metrics.Page execution time was 2850.96 ms. Memory used at: devel_boot()=9.4 MB, devel_shutdown()=116.07 MB, PHP peak=163.25 MB.And there was one really insane database query happening (yes that is 244ms!):    After token_tweaksPage execution time was 848.18 ms. Memory used at: devel_boot()=8.03 MB, devel_shutdown()=76.9 MB, PHP peak=77.75 MB.And now the query is much more manageable (0.64ms!):    How to install token_tweaksdrush dl token_tweaksdrush en token_tweaks -ydrush vset token_tree_recursion_limit 1The above code will set the recursion limit to only 1 level deep. This is the minimum allowed.Patching    contrib to support the new dialog that renders the tokensRecently there was a commit that introduced a new theme function    for rendering the the token_tree using theme_token_tree_link(). This essentially stops rendering the jQuery table    expand fieldset, and replaces it with an on-demand modal dialog. The beautiful part is that you only need to include    one additional parameter in the form element, in the case of the webform module, the token_tree form API element    went from$fieldset['token_tree'] = array(  '#theme' =&gt; 'token_tree',  '#token_types' =&gt; $groups,);to:$fieldset['token_tree'] = array(  '#theme' =&gt; 'token_tree',  '#dialog' =&gt; TRUE,  '#token_types' =&gt; $groups,);The new token dialog UIHere is a few screenshots of the new token dialog UI in action:    And when you click on the "Browse available tokens" link, this appears    There is a patch for webform that is listed at http://drupal.org/node/1801782 - hopefully contrib will start to adopt    this shortly.The best part about this is that the token_tweaks module and the new dialog work in tandem with    each other, and together they will help reduce your Drupal memory footprint, and speed up the administration side of    your site.Forcing all contrib to use the new theme_token_tree_link() functionUPDATE 18th    January 2013: Say you do want to go through the arduous task of patching all contrib that has    integration with token, there is a simplier option for you. You can instead create a custom module to override the    the theme implementation of theme_token_tree() all together./** * Implements hook_theme_registry_alter(). */function MYMODULE_theme_registry_alter(&amp;$theme_registry) {  // Prevent theme('token_tree') from generating ridiculous amounts of  // inline markup.  $theme_registry['token_tree']['function'] = 'MYMODULE_theme_token_tree';}">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- OpenGraph Tags -->
    <meta property="og:title" content="How to speed up Drupal by altering the tokens UI" />
    <meta property="og:site_name" content="Pixelite" />
    <meta property="og:url" content="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui/" />
    <meta property="og:description" content="" />
    <meta property="fb:app_id" content="410615979137383" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    
        <meta property="og:image" content="http://www.pixelite.co.nz/img/post-bg-hero.png" />
    

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@pixelite_">
    
        <meta name="twitter:creator" content="@wiifm">
    
    <meta name="twitter:title" content="How to speed up Drupal by altering the tokens UI">
    <meta name="twitter:description" content="">
    
        <meta name="twitter:image" content="http://www.pixelite.co.nz/img/post-bg-hero.png">
    


    <title>How to speed up Drupal by altering the tokens UI - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    
<!-- Main Content -->
<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="713"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui"/>

    <header class="intro-header" style="background-image: url('/img/post-bg-hero.png')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 itemprop="name headline">How to speed up Drupal by altering the tokens UI</h1>
                    

                    <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2013-01-16T00:00:00" itemprop="datePublished">January 16, 2013</time></span>
                    <ul class="social-buttons cf">
                        <li>
                            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="How to speed up Drupal by altering the tokens UI" data-url="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                        </li>
                        <li>
                            <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                        </li>
                        <li>
                            <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui&amp;t=How%20to%20speed%20up%20Drupal%20by%20altering%20the%20tokens%20UI" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                        </li>
                        <li>
                            <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui&amp;title=How%20to%20speed%20up%20Drupal%20by%20altering%20the%20tokens%20UI" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>

    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <p>On larger Drupal sites, the Token module quickly becomes unwieldy, and the UI can consume precious resources while
    often being never used. Here are some options for mitigation of this.</p><h2>Token_tweaks module</h2><p>Written by
    the same guy who wrote token, <a href="http://drupal.org/project/token_tweaks">token_tweaks</a> aims to reduce the
    recursiveness of the theme_token_tree() function. This simple fix is enough on most sites to speed up page loads,
    and reduce memory consumption.</p><p>This is a real life example from a current (large) Drupal project I am working
    on. With vanilla token module installed, and viewing an admin page with a theme_token_tree() rendered on it (it
    happens to be a webform configuration page).&nbsp;I used <a href="http://drupal.org/project/devel">devel</a> to
    produce these metrics.</p>
<pre class="brush: plain; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">Page execution time was 2850.96 ms. Memory used at: devel_boot()=9.4 MB, devel_shutdown()=116.07 MB, PHP peak=163.25 MB.</pre>
<p>And there was one really insane database query happening (yes that is 244ms!):</p><p>
    <img src="/img/tokens-ui/Selection_010.png"></p>
<p>After token_tweaks</p>
<pre class="brush: plain; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">Page execution time was 848.18 ms. Memory used at: devel_boot()=8.03 MB, devel_shutdown()=76.9 MB, PHP peak=77.75 MB.</pre>
<p>And now the query is much more manageable (0.64ms!):</p><p>
    <img src="/img/tokens-ui/Selection_011.png"></p>
<p>How to install token_tweaks</p>
<pre class="brush: bash; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">drush dl token_tweaks
drush en token_tweaks -y
drush vset token_tree_recursion_limit 1</pre>
<p>The above code will set the recursion limit to only 1 level deep. This is the minimum allowed.</p><h2>Patching
    contrib to support the new dialog that renders the tokens</h2><p>Recently there was a <a
        href="http://drupalcode.org/project/token.git/commit/fb05b22">commit</a> that introduced a new theme function
    for rendering the the token_tree using theme_token_tree_link(). This essentially stops rendering the jQuery table
    expand fieldset, and replaces it with an on-demand modal dialog. The beautiful part is that you only need to include
    one additional parameter in the form element, in the case of the webform module, the token_tree form API element
    went from</p>
<pre class="brush: php; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">$fieldset['token_tree'] = array(
  '#theme' =&gt; 'token_tree',
  '#token_types' =&gt; $groups,
);</pre>
<p>to:</p>
<pre class="brush: php; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">$fieldset['token_tree'] = array(
  '#theme' =&gt; 'token_tree',
  '#dialog' =&gt; TRUE,
  '#token_types' =&gt; $groups,
);</pre>
<h3>The new token dialog UI</h3><p>Here is a few screenshots of the new token dialog UI in action:</p><p>
    <img src="/img/tokens-ui/Selection_012.png"></p>
<p>And when you click on the "Browse available tokens" link, this appears</p><p>
    <img src="/img/tokens-ui/Selection_013.png.png"></p>
<p>There is a patch for webform that is listed at http://drupal.org/node/1801782 - hopefully contrib will start to adopt
    this shortly.</p><p>The best part about this is that the token_tweaks module and the new dialog work in tandem with
    each other, and together they will help reduce your Drupal memory footprint, and speed up the administration side of
    your site.</p><h2>Forcing all contrib to use the new theme_token_tree_link() function</h2><p><strong>UPDATE 18th
    January 2013:</strong> Say you do want to go through the arduous task of patching <em>all contrib</em> that has
    integration with token, there is a simplier option for you. You can instead create a custom module to override the
    the theme implementation of theme_token_tree() all together.</p>
<pre class="brush: php; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">/**
 * Implements hook_theme_registry_alter().
 */
function MYMODULE_theme_registry_alter(&amp;$theme_registry) {
  // Prevent theme('token_tree') from generating ridiculous amounts of
  // inline markup.
  $theme_registry['token_tree']['function'] = 'MYMODULE_theme_token_tree';
}

/**
 * By default theme('token_tree') renders ridiculous amounts of
 * inline markup. We can prevent this by forcing it to always
 * use its friendlier 'dialog' option (which instead outputs a
 * link to a separate page with all the markup).
 *
 * n.b. If the path starts with 'token/tree' then we are requesting
 * that separate page, and must render the full tree.
 *
 * @see MYMODULE_theme_registry_alter().
 */
function MYMODULE_theme_token_tree(&amp;$variables) {
  if (arg(0) != 'token' || arg(1) != 'tree') {
    $variables['dialog'] = TRUE;
  }
  return theme_token_tree($variables);
}</pre>
<p>As you can see this function adds in the #dialog parameter automatically, thus forcing the new dialog everywhere.</p>
<h2>On the horizon</h2><p>There is some movement with Drupal 8, to do a better job with this
    http://drupal.org/node/514990</p><p>Is there any other Token tips or patches that you know of? Leave me a
    comment.</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    var disqus_url = 'http://www.pixelite.co.nz/article/how-speed-drupal-altering-tokens-ui';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/what-sass-and-why-you-should-be-using-it" data-toggle="tooltip" data-placement="top" title="What is SASS and why you should be using it">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/profiling-drupal-7-performance-xhprof-and-devel" data-toggle="tooltip" data-placement="top" title="Profiling Drupal 7 performance with XHProf and Devel">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2016 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
