<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <meta name="description" content="I have been doing a bit of Drupal 8 development as of recent, and am loving the new changes, and entities everywhere. I am passionate about automated testing, and when I saw that integrating PHPunit into your custom modules is now even easier, I set out to get this integrated.">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- OpenGraph Tags -->
    <meta property="og:title" content="Writing PHPunit tests for your custom modules in Drupal 8" />
    <meta property="og:site_name" content="Pixelite" />
    <meta property="og:url" content="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" />
    <meta property="og:description" content="Integrating PHPunit into your custom modules is now even easier." />
    <meta property="fb:app_id" content="410615979137383" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    
        <meta property="og:image" content="http://www.pixelite.co.nz/img/phpunit/back.jpg" />
    

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@pixelite_">
    
        <meta name="twitter:creator" content="@wiifm">
    
    <meta name="twitter:title" content="Writing PHPunit tests for your custom modules in Drupal 8">
    <meta name="twitter:description" content="Integrating PHPunit into your custom modules is now even easier.">
    
        <meta name="twitter:image" content="http://www.pixelite.co.nz/img/phpunit/back.jpg">
    


    <title>Writing PHPunit tests for your custom modules in Drupal 8 - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    
<!-- Main Content -->
<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="1205"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/"/>

    <header class="intro-header" style="background-image: url('/img/phpunit/back.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 itemprop="name headline">Writing PHPunit tests for your custom modules in Drupal 8</h1>
                    
                    <h2 class="subheading" itemprop="description">Integrating PHPunit into your custom modules is now even easier.</h2>
                    

                    <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2016-03-24T00:00:00" itemprop="datePublished">March 24, 2016</time></span>
                    <ul class="social-buttons cf">
                        <li>
                            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Writing PHPunit tests for your custom modules in Drupal 8" data-url="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                        </li>
                        <li>
                            <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                        </li>
                        <li>
                            <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/&amp;t=Writing%20PHPunit%20tests%20for%20your%20custom%20modules%20in%20Drupal%208" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                        </li>
                        <li>
                            <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/&amp;title=Writing%20PHPunit%20tests%20for%20your%20custom%20modules%20in%20Drupal%208" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>


    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <h2 id="background">Background</h2>

<p>I have been doing a bit of Drupal 8 development as of recent, and am loving the new changes, and entities everywhere. I am passionate about automated testing, and when I saw that integrating PHPunit into your custom modules is now even easier, I set out to see how this all worked.</p>

<h2 id="why-is-phpunit-important">Why is PHPunit important</h2>

<p>There are are number of reasons why PHPunit is a great idea</p>

<ul>
  <li>it forces you to write testable code in the first place, this means small classes, with methods that do a single thing</li>
  <li>it runs in only a few seconds, there is also no need to have a working Drupal install</li>
  <li>integrates with PHPStorm, allowing you run your tests from within the IDE</li>
</ul>

<h2 id="step-1-set-up-your-phpunitxmldist-file">Step 1, set up your phpunit.xml.dist file</h2>

<p>There is a file that comes included with Drupal 8 core, but by default it will not scan any sub-directories under <code>/modules</code> (e.g. like the very common <code>/modules/custom</code>). I stumbled across this question on <a href="http://drupal.stackexchange.com/questions/162719/phpunit-with-custom-contrib-and-submodules-structure">stackoverflow</a>. So you have a couple of options from here:</p>

<h3 id="option-1---create-and-use-your-own-phpunitxmldist-file">Option 1 - Create and use your own phpunit.xml.dist file</h3>

<p>You can simply copy (and modify) Drupal 8 core’s phpunit.xml.dist file into git repo somewhere (perhaps outside the webroot), and use this file for all your custom module tests.</p>

<h3 id="option-2---patch-drupal-8-core">Option 2 - Patch Drupal 8 core</h3>

<p>Another option (which is the option I took) was to apply a simple patch to Drupal core. There is an <a href="https://www.drupal.org/node/2499239">open issue on drupal.org</a> to look at scanning all sub-directories for test files. At the time of writing it was uncertain whether this patch would be accepted by the community.</p>

<h2 id="step-2-write-your-tests">Step 2, write your tests</h2>

<p>There are some general conventions you should use when writing your PHPunit tests:</p>

<ul>
  <li>the suffix of the filename should be <code>Test.php</code>, e.g. <code>MonthRangeTest.php</code></li>
  <li>the files should all reside in either the directory <code>/MY_MODULE/tests/src/Unit/</code> or a sub directory of that</li>
</ul>

<p>More information on the requirements can be found on the <a href="https://www.drupal.org/node/2116043">drupal.org documentation</a>.</p>

<h3 id="dataproviders">Dataproviders</h3>

<p>Data providers are pretty much the best thing to happen to automated testing. Instead of testing a single scenario, you can instead test a whole range of permutations in order to find those bugs. You start by declaring an annotation <code>@dataProvider</code> for your test method:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="sd">/**</span>
<span class="sd">   * @covers ::getMonthRange</span>
<span class="sd">   * @dataProvider monthRangeDataProvider</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetMonthRange</span><span class="p">(</span><span class="nv">$expected_start</span><span class="p">,</span> <span class="nv">$expected_end</span><span class="p">,</span> <span class="nv">$month_offset</span><span class="p">,</span> <span class="nv">$now</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... more code</span>
  <span class="p">}</span></code></pre></figure>

<p>You then declare a method <code>monthRangeDataProvider</code> that returns an array of test cases (which are also arrays). The items in the data provider method are passed one at a time to the testing method, in the same order they are declared (so you can map them to friendly names).</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="sd">/**</span>
<span class="sd">   * Data provider for testGetMonthRange().</span>
<span class="sd">   *</span>
<span class="sd">   * @return array</span>
<span class="sd">   *   Nested arrays of values to check:</span>
<span class="sd">   *   - $expected_start</span>
<span class="sd">   *   - $expected_end</span>
<span class="sd">   *   - $month_offset</span>
<span class="sd">   *   - $now</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">monthRangeDataProvider</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="c1">// Feb 29 @ noon.</span>
      <span class="p">[</span><span class="mi">1454284800</span><span class="p">,</span> <span class="mi">1456790399</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1456747200</span><span class="p">],</span>
      <span class="c1">// ... more tests follow</span>
    <span class="p">];</span>
  <span class="p">}</span></code></pre></figure>

<p>More information can be found in the <a href="https://phpunit.de/manual/3.7/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.data-providers">phpunit documentation for data providers</a>.</p>

<h3 id="testing-for-expected-exceptions">Testing for expected exceptions</h3>

<p>Just as important as testing valid inputs, you should also test invalid inputs as well. This is easily achieved with <code>@expectedException</code> annotations above your test method:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="sd">/**</span>
<span class="sd">   * Tests that an end date that is before the start date produces an exception.</span>
<span class="sd">   *</span>
<span class="sd">   * @expectedException        Exception</span>
<span class="sd">   * @expectedExceptionMessage Start date must be before end date</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetWorkingDaysInRangeException</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ... more code in here</span>
  <span class="p">}</span></code></pre></figure>

<h2 id="step-3-enhance-your-test-class-with-phpunit-metadata">Step 3, enhance your test class with PHPunit metadata</h2>

<p>You can annotate both the test class and the methods to provide additional information and metadata about your tests:</p>

<p><strong>@covers</strong></p>

<p>This is mainly used for PHPunit’s automated code coverage report, but I find it also very helpful for developers to up front state what method that are testing.</p>

<p><strong>@coversDefaultClass</strong></p>

<p>This is used at a class level, and saves you having to write rather lengthy @covers statement for all your testing methods, if they all test the same class.</p>

<p><strong>@depends</strong></p>

<p>If a certain test makes no sense to run unless a previous test passed, then you can add in a ‘depends’ annotation above the test method in question. You can depend on multiple other tests too. Note, that this does not change the execution order of the tests, they are still executed top to bottom.</p>

<p><strong>@group</strong> or <strong>@author</strong></p>

<p>You can think of adding a ‘group’ to a PHPunit class the same as tagging in. It is free tagging in that sense, and you can tag a single class with many tags. This should allow you to categorise your tests. @author is an alias of group, the idea being you can run all tests written by a particular developer.</p>

<p>More information can be found in the <a href="https://phpunit.de/manual/3.7/en/appendixes.annotations.html">PHPunit documentation on annotations</a>.</p>

<h2 id="step-4-run-your-test-suite">Step 4, run your test suite</h2>

<p>This section assumes you have opted to use Drupal core’s phpunit.xml.dist file (modify the paths as appropriate if you are using a file in another location).</p>

<p>List groups (or tags)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>core/
../vendor/bin/phpunit --list-groups</code></pre></figure>

<p>Run all tests that are tags with a particular group (or tag)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>core/
../vendor/bin/phpunit --group tamdash</code></pre></figure>

<p>Example CLI output</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>../vendor/bin/phpunit --group tamdash
PHPUnit 4.8.11 by Sebastian Bergmann and contributors.
...........
Time: 5.01 seconds, Memory: 144.25Mb
OK <span class="o">(</span><span class="m">11</span> tests, <span class="m">18</span> assertions<span class="o">)</span></code></pre></figure>

<p>If you are using PHPStorm, spend a few minutes and <a href="https://www.drupal.org/node/2288559">set this up too</a>.</p>

<p><img src="/img/phpunit/phpstorm.png" alt="Set up PHPStorm to run PHPunit tests" class="img-responsive img-thumbnail" /></p>

<p>Example output</p>

<p><img src="/img/phpunit/phpstorm-run.png" alt="Running PHPunit tests in PHPStorm" class="img-responsive img-thumbnail" /></p>

<p>So now there is no need to flip back to your terminal if you just want to quickly run a group of tests.</p>

<h2 id="conclusion">Conclusion</h2>

<p>PHPunit is a great way to be able to run quick tests on isolated parts of your code. Tests often take less than 10 seconds to run, so developer feedback is near instant. It also forces your developers to write better more testible code from the get go. This can only be a good thing. Personally I am very excited to see PHPunit join Drupal 8, and cannot wait to see what people do with it.</p>

<h2 id="comments">Comments</h2>

<p>There seems to be quite healthy debate on whether contrib or custom modules should ship with their own phpunit.xml.dist file or whether Drupal core’s file should cover both. I am keen to hear anyone’s thoughts on this. Also let me know if you have any contrib modules in the wild shipping their own phpunit.xml.dist files, and how you found that process.</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    
                        var disqus_url = 'http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/';
                    

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" data-toggle="tooltip" data-placement="top" title="Deleting multiple fields with large amounts of data in Drupal 7">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2016 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
