<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <meta name="description" content="I recently was tasked with cleaning up a legacy Drupal 7 database to which had accumulated a lot of data in fields.">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- OpenGraph Tags -->
    <meta property="og:title" content="Deleting multiple fields with large amounts of data in Drupal 7" />
    <meta property="og:site_name" content="Pixelite" />
    <meta property="og:url" content="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" />
    <meta property="og:description" content="Sometimes truncation is best" />
    <meta property="fb:app_id" content="410615979137383" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    
        <meta property="og:image" content="http://www.pixelite.co.nz/img/plymouth.jpg" />
    

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@pixelite_">
    
        <meta name="twitter:creator" content="@wiifm">
    
    <meta name="twitter:title" content="Deleting multiple fields with large amounts of data in Drupal 7">
    <meta name="twitter:description" content="Sometimes truncation is best">
    
        <meta name="twitter:image" content="http://www.pixelite.co.nz/img/plymouth.jpg">
    


    <title>Deleting multiple fields with large amounts of data in Drupal 7 - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    
<!-- Main Content -->
<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="526"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/"/>

    <header class="intro-header" style="background-image: url('/img/plymouth.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 itemprop="name headline">Deleting multiple fields with large amounts of data in Drupal 7</h1>
                    
                    <h2 class="subheading" itemprop="description">Sometimes truncation is best</h2>
                    

                    <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2016-02-17T00:00:00" itemprop="datePublished">February 17, 2016</time></span>
                    <ul class="social-buttons cf">
                        <li>
                            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Deleting multiple fields with large amounts of data in Drupal 7" data-url="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                        </li>
                        <li>
                            <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                        </li>
                        <li>
                            <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/&amp;t=Deleting%20multiple%20fields%20with%20large%20amounts%20of%20data%20in%20Drupal%207" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                        </li>
                        <li>
                            <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/&amp;title=Deleting%20multiple%20fields%20with%20large%20amounts%20of%20data%20in%20Drupal%207" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>


    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <h2 id="background">Background</h2>

<p>I was recently tasked with cleaning up a legacy Drupal 7 database to which had accumulated a lot of data in several fields. The fields were no longer used, and the data could be deleted. The data however totalled more than <em>30 GB</em> with those 7 fields, and this presented a few challenges.</p>

<h2 id="existing-solutions-that-did-not-quite-cut-it">Existing solutions that did not quite cut it</h2>

<p>I search around the internet to see the best way to delete fields in Drupal 7 using an update hook. I came across this <a href="http://drupal.stackexchange.com/questions/46085/how-to-programmatically-remove-a-field-from-a-node">stack overflow post</a> to which advised using something like:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">EXAMPLE_update_7001</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">field_delete_field</span><span class="p">(</span><span class="s1">&#39;field_name&#39;</span><span class="p">);</span>
  <span class="nx">field_purge_batch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span></code></pre></figure>

<p>The main issue with the above code is that it only marks the data for deletion, and then slowly removes it on cron. This could take  weeks to fully remove the data. It was not an ideal solution in our case.</p>

<h2 id="solution">Solution</h2>

<p>If you want to expatiate the process of removing data from fields, and also the fields themselves, we found the code below would remove the 30 GB of data, remove the tables, update the content types, all in one nice update hook. It does rely on having removed the fields from your features, so that are the respective content type can be reverted successfully.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">EXAMPLE_update_7001</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$fields_to_delete</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;field_example_a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_example_b&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_example_c&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_example_d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_example_e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_example_f&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_example_g&#39;</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields_to_delete</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db_truncate</span><span class="p">(</span><span class="s1">&#39;field_data_&#39;</span> <span class="o">.</span> <span class="nv">$field</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
    <span class="nx">db_truncate</span><span class="p">(</span><span class="s1">&#39;field_revision_&#39;</span> <span class="o">.</span> <span class="nv">$field</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
    <span class="nx">field_delete_field</span><span class="p">(</span><span class="nv">$field</span><span class="p">);</span>
    <span class="nx">watchdog</span><span class="p">(</span><span class="s1">&#39;EXAMPLE&#39;</span><span class="p">,</span> <span class="s1">&#39;Deleted the field @field from all content types.&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;@field&#39;</span> <span class="o">=&gt;</span> <span class="nv">$field</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="sd">/**</span>
<span class="sd">   * The fields aren&#39;t really deleted until the purge function runs, ordinarily</span>
<span class="sd">   * during cron. Count the number of fields we need to purge, and add five in</span>
<span class="sd">   * case a few other miscellaneous fields are in there somehow.</span>
<span class="sd">   */</span>
  <span class="nx">field_purge_batch</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$fields_to_delete</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>

  <span class="c1">// Revert features to update the content type in Drupal to drop the field.</span>
  <span class="nx">features_revert</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;EXAMPLE&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)));</span>
<span class="p">}</span></code></pre></figure>

<h2 id="conclusions">Conclusions</h2>

<p>A couple of lessons can be learnt here</p>

<ul>
  <li>Truncations, even on large data sets, are extremely quick, and awesome. The above update hook takes less than 1 minute to run end to end.</li>
  <li>If you are going to programmatically update nodes with a high degree of frequency, consider <a href="https://www.drupal.org/project/field_sql_norevisions">disabling revisions</a> on those content types. Your database thanks you in advance.</li>
</ul>

<h2 id="comments">Comments</h2>

<p>If you have had to delete fields in update hooks in Drupal, let me know if you used another method and how that went for you.</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    
                        var disqus_url = 'http://www.pixelite.co.nz/article/deleting-multiple-fields-with-large-amounts-of-data-in-drupal-7/';
                    

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/estimating-drupal-projects/" data-toggle="tooltip" data-placement="top" title="Estimating Drupal projects">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/writing-phpunit-tests-for-your-custom-modules-in-drupal-8/" data-toggle="tooltip" data-placement="top" title="Writing PHPunit tests for your custom modules in Drupal 8">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2016 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
