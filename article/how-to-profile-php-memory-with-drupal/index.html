<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <meta name="description" content="How to size the PHP setting max_memory is actually really important for the health of your Drupal application">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- OpenGraph Tags -->
    <meta property="og:title" content="How to profile PHP memory with Drupal" />
    <meta property="og:site_name" content="Pixelite" />
    <meta property="og:url" content="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/" />
    <meta property="og:description" content="Simple steps to tune your application" />
    <meta property="fb:app_id" content="410615979137383" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    
        <meta property="og:image" content="http://www.pixelite.co.nz/img/profile/back.jpg" />
    

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@pixelite_">
    
        <meta name="twitter:creator" content="@wiifm">
    
    <meta name="twitter:title" content="How to profile PHP memory with Drupal">
    <meta name="twitter:description" content="Simple steps to tune your application">
    
        <meta name="twitter:image" content="http://www.pixelite.co.nz/img/profile/back.jpg">
    


    <title>How to profile PHP memory with Drupal - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    
<!-- Main Content -->
<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="635"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/"/>

    <header class="intro-header" style="background-image: url('/img/profile/back.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 itemprop="name headline">How to profile PHP memory with Drupal</h1>
                    
                    <h2 class="subheading" itemprop="description">Simple steps to tune your application</h2>
                    

                    <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2015-05-27T00:00:00" itemprop="datePublished">May 27, 2015</time></span>
                    <ul class="social-buttons cf">
                        <li>
                            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="How to profile PHP memory with Drupal" data-url="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                        </li>
                        <li>
                            <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                        </li>
                        <li>
                            <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/&amp;t=How%20to%20profile%20PHP%20memory%20with%20Drupal" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                        </li>
                        <li>
                            <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/&amp;title=How%20to%20profile%20PHP%20memory%20with%20Drupal" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>


    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <h2 id="why-is-this-important">Why is this important</h2>

<p>How to size the PHP setting <code>max_memory</code> is actually really important for the health of your Drupal application. Size this too small, and you risk getting PHP fatals due to not enough memory allocated. Size this too large, and you are essentially under-utilising your hardware, which in turn can lead to more cost.</p>

<h2 id="how-to-record-every-drupal-requests-php-max-memory-usage">How to record every Drupal requests PHP max memory usage</h2>

<p>Tim Hillard created this really nice module called <a href="https://www.drupal.org/project/memory_profiler">Memory profiler</a>, which probably wins some sort of award for being around one of the smallest modules on drupal.org. Essentially this module registers a <a href="https://api.drupal.org/api/drupal/includes%21bootstrap.inc/function/drupal_register_shutdown_function/7">shutdown function</a> that gets called at the end of every normal Drupal request.</p>

<p>The module is lightweight enough to run on production and only produces an extra syslog line per request.</p>

<h2 id="analyse-the-data">Analyse the data</h2>

<p>The data for memory profiler flows into watchdog, so if you run syslog (which you should), you can use CLI tools to analyse the data.</p>

<h3 id="what-does-a-single-request-look-like">What does a single request look like</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>grep <span class="s2">&quot;memory profiler&quot;</span> drupal-watchdog.log <span class="p">|</span> head -n 1

May <span class="m">26</span> 06:25:21 10.212.4.16 sitename: https://www.sitename.com<span class="p">|</span>1432621521<span class="p">|</span>memory profiler<span class="p">|</span>1.152.97.17<span class="p">|</span>https://www.sitename.com/<span class="p">|</span>https://www.sitename.com/home<span class="p">|</span>0<span class="o">||</span>4.75 MB - home <span class="nv">request_id</span><span class="o">=</span><span class="s2">&quot;v-fc9573dc-036f-11e5-a8c0-22000af91462&quot;</span></code></pre></figure>

<p>This comes from your syslog format (which can be changed on a per site basis):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>drush vget syslog_format

syslog_format: <span class="s1">&#39;!base_url|!timestamp|!type|!ip|!request_uri|!referer|!uid|!link|!message&#39;</span></code></pre></figure>

<h3 id="extract-the-data-from-syslog">Extract the data from syslog</h3>

<p>From here you can tokenise the parts you actually care about, in other words the:</p>

<ul>
  <li>URL requested (part 5)</li>
  <li>PHP max memory (part 9)</li>
</ul>

<p>Using more bash foo</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>grep <span class="s2">&quot;memory profiler&quot;</span> drupal-watchdog.log <span class="p">|</span> head -n <span class="m">1</span> <span class="p">|</span> awk -F<span class="s1">&#39;|&#39;</span> -v <span class="nv">OFS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $5, $9}&#39;</span>

https://www.sitename.com/,4.75 MB - home <span class="nv">request_id</span><span class="o">=</span><span class="s2">&quot;v-fc9573dc-036f-11e5-a8c0-22000af91462&quot;</span></code></pre></figure>

<p>On Acquia Cloud a request ID is added to all requests, we don’t need this. Also having the string ‘MB’ there is superfluous.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>grep <span class="s2">&quot;memory profiler&quot;</span> drupal-watchdog.log <span class="p">|</span> head -n <span class="m">1</span> <span class="p">|</span> awk -F<span class="s1">&#39;|&#39;</span> -v <span class="nv">OFS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $5, $9}&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/ MB.*//&#39;</span>

https://www.sitename.com/,4.75</code></pre></figure>

<p>Perfect.</p>

<p>So in order to create a CSV for analysing in a spreadsheet you could do:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;request_uri,max_memory&quot;</span> &gt; /tmp/memory.csv <span class="o">&amp;&amp;</span> grep <span class="s2">&quot;memory profiler&quot;</span> drupal-watchdog.log <span class="p">|</span> awk -F<span class="s1">&#39;|&#39;</span> -v <span class="nv">OFS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $5, $9}&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/ MB.*//&#39;</span> &gt;&gt; /tmp/memory.csv</code></pre></figure>

<p>And then you can make pretty graphs if you want:</p>

<p><img src="http://www.pixelite.co.nz/img/profile/graph.png" alt="Graph showing PHP memory usage sorted by smallest to largest" class="img-responsive img-thumbnail" /></p>

<p>Or if you just want to find the top requests to your application by memory you can do</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>grep <span class="s2">&quot;memory profiler&quot;</span> drupal-watchdog.log <span class="p">|</span> awk -F<span class="s1">&#39;|&#39;</span> -v <span class="nv">OFS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $5, $9}&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/ MB.*//&#39;</span> <span class="p">|</span> sort -t, -k+2 -n -r <span class="p">|</span> head -n 20</code></pre></figure>

<h2 id="conclusions">Conclusions</h2>

<p>Based on your findings in the logs, you should be able to come up with:</p>

<ul>
  <li>A better understanding of your request memory profile</li>
  <li>Better max memory settings for your Drupal application</li>
  <li>Potentially identify poor performing pages (memory wise) and can look to optimise them</li>
</ul>

<h2 id="gotchas">Gotchas</h2>

<p>This module will only work if:</p>

<ul>
  <li><code>hook_boot()</code> is called (which might not be the case if you run custom lightweight PHP scripts that do not bootstrap Drupal)</li>
  <li>The Drupal request is not terminated with a SIGTERM or SIGKILL signal</li>
</ul>

<h2 id="comments">Comments</h2>

<p>Let me know if you found this helpful, or if you have any changes to my bash foo. If you have profiled your Drupal application recently, what methods and tools did you use?</p>

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    
                        var disqus_url = 'http://www.pixelite.co.nz/article/how-to-profile-php-memory-with-drupal/';
                    

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/top-10-drupalcon-la-sessions/" data-toggle="tooltip" data-placement="top" title="Top 10 DrupalCon LA sessions">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/debugging-drupal-performance-with-cache-debug/" data-toggle="tooltip" data-placement="top" title="Debugging Drupal performance with Cache Debug module">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2016 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
