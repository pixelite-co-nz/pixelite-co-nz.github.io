<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Drupal.org has this information, but it is largely scattered around on these URLs:">
    


    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>A practical example for converting a Drupal 7 module to work with Drupal 8 - Pixelite</title>

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="All posts" href="http://www.pixelite.co.nz/feed.xml" />
    <link rel="alternate" type="application/rss+xml" title="All Drupal planet posts" href="http://www.pixelite.co.nz/drupalplanet.xml" />

    <link rel="canonical" href="http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-pixelite" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img alt="Pixelite homepage" src="/img/pixelite.svg" width="180" height="60" /></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about.html">About</a>
                </li>
                <li>
                    <a href="/contact.html">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    

<article itemscope="" itemtype="http://schema.org/BlogPosting">
    <meta itemprop="inLanguage" content="en-GB"/>
    <meta itemprop="wordCount" content="1034"/>
    <meta itemprop="url" content="http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8"/>

    <!-- Post Header -->
    <header class="intro-header" style="background-image: url('/')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1 itemprop="name headline">A practical example for converting a Drupal 7 module to work with Drupal 8</h1>
                        

                        <span class="meta">Posted by <a href="/authors/sean-hamlin/" title="View Sean Hamlin's profile"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Sean Hamlin</span></span></a> on <time datetime="2013-07-14T00:00:00" itemprop="datePublished">July 14, 2013</time></span>
                        <ul class="social-buttons cf">
                            <li>
                                <a href="http://twitter.com/share" class="socialite twitter-share" data-text="A practical example for converting a Drupal 7 module to work with Drupal 8" data-url="http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
                            </li>
                            <li>
                                <a href="https://plus.google.com/share?url=http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8" class="socialite googleplus-one" data-size="tall" data-href="http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8" rel="nofollow" target="_blank"><span class="vhidden">Share on Google+</span></a>
                            </li>
                            <li>
                                <a href="http://www.facebook.com/sharer.php?u=http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8&amp;t=A%20practical%20example%20for%20converting%20a%20Drupal%207%20module%20to%20work%20with%20Drupal%208" class="socialite facebook-like" data-href="http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
                            </li>
                            <li>
                                <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8&amp;title=A%20practical%20example%20for%20converting%20a%20Drupal%207%20module%20to%20work%20with%20Drupal%208" class="socialite linkedin-share" data-url="http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                <div itemprop="articleBody">
                    <p>Drupal.org has this information, but it is largely scattered around on these URLs:</p>

<ul>
  <li><a href="https://drupal.org/update/modules/7/8">https://drupal.org/update/modules/7/8</a></li>
  <li><a href="https://drupal.org/list-changes/drupal?to_branch=8.x">https://drupal.org/list-changes/drupal?to_branch=8.x</a></li>
</ul>

<p>It can be hard to find a real life example on how to update your contributed modules with the new Drupal 8 architecture.</p>

<p>Here is an example module that I maintain (<a href="https://drupal.org/project/js_injector">js_injector</a>), which at the moment depends on:</p>

<ul>
  <li>Drupal 7 core</li>
  <li>ctools exportables (see the <a href="https://drupal.org/node/928026">documentation</a> for more information on this)</li>
</ul>

<p>I am going to try and refactor the module to use Drupal 8 core components only and deprecate the ctools dependency.</p>

<h2 id="the-info-is-dead-long-live-yaml">The .info is dead, long live <abbr title="YAML Ain't Markup Language">YAML</abbr></h2>

<p>One of the first things you will notice is there is no longer the <code>.ini</code> syntax .info file in the root of the module. It has now been converted to <abbr title="YAML Ain't Markup Language">YAML</abbr>.</p>

<p><strong>Old info file:</strong></p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">name = JS injector</span>
<span class="x">description = Adds JavaScript to the page output based on configurable rules</span>
<span class="x">core = 7.x</span>
<span class="x">configure = admin/config/development/js-injector</span>
<span class="x">dependencies[] = ctools</span></code></pre></div>

<p><strong>New .info.yml file</strong></p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">name: &#39;JS injector&#39;</span>
<span class="x">type: module</span>
<span class="x">description: &#39;Adds JavaScript to the page output based on configurable rules.&#39;</span>
<span class="x">core: 8.x</span>
<span class="x">configure: admin/config/development/js-injector</span></code></pre></div>

<p>So not too many changes here, mainly just syntax. It is important to read the <a href="https://drupal.org/node/1935708">change record</a> for this if you .info file is more advanced, as items such as the new autoloader deprecate the Drupal 7 <code>files[]</code> super arrays.</p>

<h2 id="the-switch-from-ctools-exportables-to-drupal-8s-configuration-entities-cmi">The switch from ctools exportables to Drupal 8’s configuration entities (<abbr title="Configuration Management Initiative">CMI</abbr>)</h2>

<p>One of the major changes to Drupal 8 is the Configuration Management Initiative (<abbr title="Configuration Management Initiative">CMI</abbr>). This initiative was introduced as a standardised way to have configuration stored outside your database, so that it could be staged and deployed. There were helper modules for Drupal 7 to do some of this (e.g. Features and strongarm) but there were always holes with this approach (e.g. try and export a block configuration). <abbr title="Configuration Management Initiative">CMI</abbr> solves this issue by storing <em>all</em> configuration as configuration entities that reside solely in the filesystem as <abbr title="YAML Ain't Markup Language">YAML</abbr> files.</p>

<p>You can take a sneak peak are what Drupal is storing in <abbr title="YAML Ain't Markup Language">YAML</abbr> if you open up the directory sites/default/files/config_[hash]/active</p>

<p><img src="/img/d7-d8/d8-yaml.png" alt="YAML files sitting in the config directory in Drupal 8" /></p>

<h3 id="what-this-meant-for-the-jsinjector-module">What this meant for the js_injector module</h3>

<p>This code could be re-used:</p>

<ul>
  <li>the form API definition - pretty much no changes here which is nice</li>
</ul>

<p>This code was changed/new:</p>

<ul>
  <li>Removal of all ctools plugins supporting code</li>
  <li>Update hook to convert all legacy rows in the custom table into new configuration entities</li>
  <li>Removal of hook_schema() as this is no longer required</li>
  <li>New classes that implement/extend the required interfaces that the <abbr title="Configuration Management Initiative">CMI</abbr> provides</li>
  <li>Annotations, these are fun</li>
  <li>Converting all load functions to use the entity loading framework</li>
</ul>

<p>All in all, it is a massive change to switch from ctools exportables to the new <abbr title="Configuration Management Initiative">CMI</abbr> configuration entities. But when it is all said and done, the new code is much cleaner, easier to read and is lazily loaded with the new Symfony autoloader.</p>

<p>Here is a screenshot of the new entitylist screen:</p>

<p><img src="/img/d7-d8/js_injector_d8.png" alt="New CMI based entity list screen in Drupal 8" /></p>

<p>Another really awesome resource I found for <abbr title="Configuration Management Initiative">CMI</abbr> information was actually the user roles <abbr title="Configuration Management Initiative">CMI</abbr> configuration found in Drupal 8 core. You can view the code <a href="http://drupalcode.org/project/drupal.git/tree/refs/heads/8.x:/core/modules/user">online within the repository</a>.</p>

<p>Helpful links:</p>

<ul>
  <li>Blog post by PreviousNext on <a href="http://previousnext.com.au/blog/understanding-drupal-8s-config-entities">config entities</a></li>
  <li>Drupal 8 <a href="https://drupal.org/node/1479454">conversion of user_roles into <abbr title="Configuration Management Initiative">CMI</abbr></a></li>
  <li>Drupal <a href="https://drupal.org/node/1818734">change notice</a></li>
</ul>

<h2 id="hookmenu-is-still-there-but-now-with-symfony-routes-integration">hook_menu() is still there, but now with Symfony routes integration</h2>

<p><strong>Old hook_menu() code:</strong></p>

<p>None, this was handled entirely by ctools exportables.</p>

<p><strong>New hook_menu() code:</strong></p>

<pre><code>$items['admin/config/development/js-injector'] = array(
  'title' =&gt; 'JS injector rules',
  'description' =&gt; 'Add and modify JavaScript injector rules.',
  'route_name' =&gt; 'js_injector_rule_admin',
);
</code></pre>

<p><strong>New route information (in file js_injector.routing.yml):</strong></p>

<pre><code>js_injector_rule_admin:
  pattern: '/admin/config/development/js-injector'
  defaults:
    _entity_list: 'js_injector_rule'
  requirements:
    _permission: 'administer js_injector'
</code></pre>

<p>The new Symfony routing components extend what was impossible with plain ol hook_menu() in Drupal 7. It is now possible to overload path placeholders and have one that listens for an integer, and another that is listening for a string. Similarly you can also add HTTP requirements to each end point.</p>

<p>For more information see the <a href="https://drupal.org/node/1800686">change request</a> and the <a href="http://symfony.com/doc/current/book/routing.html">Symfony documentation</a>.</p>

<h2 id="hookinit-is-gone">hook_init() is gone</h2>

<p>I was wondering why this hook was not firing, turns out this was <a href="https://drupal.org/node/2013014">removed recently</a> - I was able to replace it instead with <a href="https://api.drupal.org/api/drupal/core%21modules%21system%21system.api.php/function/hook_page_build/8">hook_page_build()</a>.</p>

<p>So this was a simple change. I actually like this change from Drupal here, as all to often contributed modules like to do silly expensive things within hook_init() not realising in Drupal 7 they fire on every page request.</p>

<h2 id="getq-is-gone">$_GET[‘q’] is gone</h2>

<p>The PHP super global key<code> $_GET['q']</code> is 100% missing in Drupal 8, now you are forced to use the standard method current_path(). For more information see the <a href="https://drupal.org/node/1659562">change request</a>.</p>

<h2 id="variablesetvariableget-are-gone">variable_set()/variable_get() are gone</h2>

<p>In Drupal 7, all variables are global, so accessing and saving them is done this way:</p>

<pre><code>// Load the site name out of configuration.
$site_name = variable_get('site_name', 'Drupal');
// Change the site name to something else.
variable_set('site_name', 'This is the dev site.');
</code></pre>

<p>In Drupal 8, configuration will only be lazy-loaded when needed. The above code would therefore change as follows:</p>

<pre><code>// Load the site name out of configuration.
$config = config('core.site_information');
$site_name = $config-&gt;get('site_name');
// Change the site name to something else.
$config-&gt;set('site_name', 'My Awesome Site');
$config-&gt;save();
</code></pre>

<p>It would be worth reading <a href="https://drupal.org/node/1667896">this tutorial</a> for more information on how to upgrade your code.</p>

<h2 id="conclusion">Conclusion</h2>

<p>So it took a few hours of reading, writing, testing, breaking and fixing in order to upgrade the js_injector module to Drupal 8, but all in all, it was a positive experience. I have created a 8.x-1.x branch for js_injector and did the <a href="http://drupalcode.org/project/js_injector.git/commit/a007b54dddf2fc3f6c9f7fa88014c0d29d7c5f44">entire upgrade largely with one commit</a>.</p>

<p>I encourage you to read through the commit, hopefully this comes in handy for your module in the near future. I am keen to hear feedback on this branch, let me know how well the module worked for you on Drupal 8, and if you have any suggestions for improvements let me know.</p>

<!-- Abbreviations -->

                </div>

                <hr>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'pixelite'; // required: replace example with your forum shortname
                    var disqus_url = 'http://www.pixelite.co.nz/article/practical-example-converting-drupal-7-module-work-drupal-8';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/article/how-find-and-debug-large-variables-drupal-7" data-toggle="tooltip" data-placement="top" title="How to find and debug large variables in Drupal 7">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="http://www.pixelite.co.nz/article/drupal-7-backbone-js-part-1-setting-upinstallation" data-toggle="tooltip" data-placement="top" title="Drupal 7 & Backbone JS: Part 1 - Setting up/Installation">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>

</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">

        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/pixelite_">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/pixelite-co-nz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">&copy; Pixelite 2015 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- JS libs -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/socialite.min.js"></script>

<!-- Custom JS -->
<script src="/js/clean-blog.js"></script>

<!-- Social links -->
<script type="text/javascript">
    (function($) {
        Socialite.load();
    })(jQuery);
</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-34737960-1', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
